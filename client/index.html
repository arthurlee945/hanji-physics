<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://arthurlee.bio/favicon.ico">
    <title>Hanji Physics Demo Page</title>
</head>
<style>
    *,
    ::before,
    ::after {
        box-sizing: border-box; 
        border-width: 0; 
        border-style: solid; 
    }
    body {
        margin: 0;
        line-height: inherit; 
        font-family: sans-serif;
        background-color: #0d0d0d;
        color: #e4e4e4;
    }
    .main-container {
        width: 100vw;
        height: 100vh;
        display:flex;
        flex-direction: column;
        align-items: center;
        row-gap: 15px;
        padding: 50px 200px;
    }
    .hanji-header {
        display:flex;
        justify-content: center;
        position:relative;
        font-size:2rem;
        transition: letter-spacing 300ms;
    }
    .hanji-header >a{
        color:#f0efef;
        text-decoration: unset;
    }
    .hanji-header:hover{
        letter-spacing: 0.1rem;
    }
    .hanji-header::after{
        content:"";
        position:absolute;
        height:2px;
        bottom:-2px;
        background-color: #f0efef;
        width:0px;
        transition: width 300ms;
    }
    .hanji-header:hover::after{
        width:100%;
    }
    .canvas-container {
        border:1px solid #e4e4e4;
        height:100%;
        width:100%;
        border-radius: 25px;
        overflow: hidden;
    }
    .hanji-display {
        width:100%;
        height:100%;
    }
</style>
<body>
    <section class = "main-container">
        <h1 class="hanji-header"><a href="https://github.com/arthurlee945/hanji-physics" target="_blank">Hanji Physics <span id="ws-connection-header">(Closed)</span></a></h1>
        <div class="canvas-container">
            <canvas id="hanji-display" class="hanji-display"/>
        </div>
    </div>
    <script>
        function throttle(cb, delay = 500) {
            let waiting = false;
            let waitingArgs;

            const timeoutFunc = () => {
                if (waitingArgs == null) {
                waiting = false;
                } else {
                    cb(...waitingArgs);
                    waitingArgs = null;
                    setTimeout(timeoutFunc, delay);
                }
            };

            return (...args) => {
                if (waiting) {
                waitingArgs = args;
                return;
                }
                cb(...args);
                waiting = true;
                setTimeout(timeoutFunc, delay);
            };
        }

        class PositionEvent {
            constructor(type, position) {
                this.type = type;
                this.position = position;
            }
        }

        function routeEvent(event){
            if (event.type === "undefined" ){
                alert("no type field in the event")
            }

            switch(event.type) {
                case "hover":
                    console.log("new MSG", event.position)
                    //add func to update canvas to follow other user's cursor
                    break;
                default:
                    alert("unsupported type");
                    break;
            }
        }
        function sendEvent(eventName, position, conn) {
            if (!conn) return;
            const event = new PositionEvent(eventName, position)
            conn.send(JSON.stringify(event))
        }

        function sendPosition(e, conn) {
            if (!conn) return;
            const {left, top} = e.target.getBoundingClientRect();
            const [x, y] = [e.clientX -left, e.clientY - top];
            sendEvent("hover", {x, y}, conn)
        }

        async function login() {
            const sampleHeader = {token: "MonkeySaysHi"};
            try {
                const res = await fetch("authorize", {
                    method:"post",
                    headers:sampleHeader,
                    mode:"cors"
                })
                if (!res.ok) throw Error("unauthorized")
                const data = await res.json();

                connectWebsocket(data.otp)
            }catch(err) {
                alert(err)
            }
        }

        function connectWebsocket(otp){
            const display = document.getElementById("hanji-display");
            const wsHeader = document.getElementById("ws-connection-header")
            if(!display) return;
            if(!window["WebSocket"]) {
                alert("No Websocket Support")
            }
            const conn = new WebSocket("wss://" + document.location.host + `/ws?otp=${otp}`);

            conn.onopen = (ev)=> {
                console.log("Websocket Connected")
                if (wsHeader) wsHeader.innerText = "(Connected)"
                display.addEventListener("mousemove", throttle((e)=> sendPosition(e, conn),50))
            }
            conn.onmessage = (ev) => {
                try {
                    const eventData = JSON.parse(ev.data);
                    console.log(eventData)
                    const pEvent = new PositionEvent("hover", eventData)
                }catch(err){
                    console.error(err)
                }
            }
            conn.onclose = (ev) => {
                if (!wsHeader) wsHeader.innerText = "(Closed)"
            }
        }
        window.addEventListener("load", ()=> {

            login();
        })

    </script>
</body>
</html>